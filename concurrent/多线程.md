# 多线程

## 基础概念

1. 进程和线程的区别。
   - 基本概念
     - 进程：并发程序在执行过程中**分配和管理资源**的**基本单位**。
       
       > Java中启动main函数就是启动一个JVM的进程。
       
     - 线程：是进程的一个**执行单元**，也被称作轻量级进程。线程不直接分配资源，进程共享进程的资源。处理器调度的基本单位。
       
       > main函数所在线程就是进程中的一个线程，是主线程。
     
   - 区别：
     - **地址空间**：线程共享本进程的地址空间，而进程之间是独立的地址空间。
     
     - **资源**：线程共享本进程的资源：IO, CPU等，进程之间资源独立。
       
       > 从Java内存区域来说，进程有自己的堆和方法区，线程私有虚拟机栈，本地方法栈和程序计数器。
       
     - **切换**：进程切换时消耗资源大，使用线程切换明显优于进程。
   
2. 并发与并行

   并发：同一时段内，多个任务**交替**执行（单位时间片上只有一个任务在执行）
   > 单核 CPU 多任务轮流切换执行：并发

   并行：单位时间片内，多个任务**同时**执行。

   > 多核CPU多任务：并行

3. 线程状态

   New：线程被构建，但还没有start()

   Runnable：运行状态。Java中把running和ready统称runnable

   Blocked：阻塞状态，等待获取到锁。

   Waiting：等待状态，需要其他线程做出特定动作来唤醒。

   TIME_Waiting：超市等待状态，不同于waiting，在指定时间自行转成runnable状态

   Terminated：执行完毕。

   <img src = "./img/Java线程状态变化.PNG" height = 60% width = 60%>

4. 线程死锁。

   死锁必要条件：

   - 互斥：该资源某一时刻只能由**一个线程**占有

   - 请求与保持：线程当请求资源被阻塞时，不放弃已经获得的资源。

     > 在申请资源时一次性申请所有资源

   - 不剥夺：线程已获得的资源在未执行完之前不可以被其他线程强行剥夺，只能在自己使用完之后使用资源。

     > 占用部分资源的线程被阻塞后主动释放自己已占有的资源

   - 循环等待：若干进程之间形成一个头尾相接的循环等待资源关系。

     > 按序申请资源。按正序申请资源，反序释放资源

## 锁

### 锁分类

1. 要不要锁住同步资源？

   悲观锁：锁住资源，获取到锁才可以访问。用于容易发生冲突的地方，用于写多的场景。

   乐观锁：不锁资源，更新数据时判断是否发生冲突，发生冲突的话再进行修补。用于读多的场景。

2. 获取锁失败，线程要不要阻塞？

   不阻塞的